# ----- Homebrew (macOS)
{{ if eq .os "darwin" -}}
eval "$(/opt/homebrew/bin/brew shellenv)"
{{- end }}

# ----- PATH
export PATH="$HOME/.local/bin:$PATH"

# Pro tip: Run 'dx' for a cheatsheet of all your tools!

# ----- History
HISTFILE="$HOME/.zsh_history"
HISTSIZE=10000
SAVEHIST=10000
setopt INC_APPEND_HISTORY SHARE_HISTORY HIST_IGNORE_DUPS

# ----- fzf keybindings (if installed)
if command -v brew >/dev/null 2>&1; then
  FZF_BIND="$(brew --prefix)/opt/fzf/shell/key-bindings.zsh"
  [ -f "$FZF_BIND" ] && source "$FZF_BIND"
fi

# ----- Powerlevel10k
if command -v brew >/dev/null 2>&1; then
  P10K="$(brew --prefix)/opt/powerlevel10k/powerlevel10k.zsh-theme"
  [ -r "$P10K" ] && source "$P10K"
fi
[[ -f "$HOME/.p10k.zsh" ]] && source "$HOME/.p10k.zsh"

# ----- Modern CLI replacements
if command -v eza >/dev/null 2>&1; then
  alias ls='eza --icons --git --group-directories-first'
  alias ll='eza -lah --icons --git --group-directories-first'
  alias lt='eza --tree --level=2 --icons'
else
  alias l='ls -lah'
fi

if command -v bat >/dev/null 2>&1; then
  alias cat='bat --style=auto --paging=never'
  alias less='bat --style=auto'
fi

# ----- Git aliases
alias gs='git status'
alias gc='git commit'
alias gp='git push'
alias lg='lazygit'

# ----- General aliases
alias v='nvim'
alias ..='cd ..'
alias ...='cd ../..'

# ----- Custom Aliases
alias letsbanj="sh $HOME/Documents/repos/banja-claude/run.sh"
alias kclean='kubectl get pods -A --no-headers | gawk '\''$4=="Evicted" || $4=="Completed" || $4=="Error" || $4=="CrashLoopBackOff" || $4=="ContainerStatusUnknown" {print "kubectl delete pod -n " $1 " " $2}'\'' | sh'

# ----- Kubernetes aliases
alias k='kubectl'
alias kx='kubectx'
alias kn='kubens'
alias logs='stern'

# ----- Editor
export EDITOR="nvim"
export VISUAL="nvim"

# ----- nvm
export NVM_DIR="$([[ -z "${XDG_CONFIG_HOME-}" ]] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Auto-switch Node version based on .nvmrc
autoload -U add-zsh-hook
load-nvmrc() {
  local node_version="$(nvm version)"
  local nvmrc_path="$(nvm_find_nvmrc)"

  if [ -n "$nvmrc_path" ]; then
    local nvmrc_node_version=$(nvm version "$(cat "${nvmrc_path}")")

    if [ "$nvmrc_node_version" = "N/A" ]; then
      nvm install
    elif [ "$nvmrc_node_version" != "$node_version" ]; then
      nvm use
    fi
  elif [ "$node_version" != "$(nvm version default)" ]; then
    echo "Reverting to nvm default version"
    nvm use default
  fi
}
add-zsh-hook chpwd load-nvmrc
load-nvmrc

# ----- direnv
eval "$(direnv hook zsh)"

# ----- zoxide (smarter cd)
if command -v zoxide >/dev/null 2>&1; then
  eval "$(zoxide init zsh)"
  alias cd='z'
fi

# ----- zsh-autosuggestions
if [ -f "$(brew --prefix)/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ]; then
  source "$(brew --prefix)/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
fi

# ----- zsh-syntax-highlighting (must be last)
if [ -f "$(brew --prefix)/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]; then
  source "$(brew --prefix)/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
fi

# ----- bun
[ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"

# ----- Kubernetes
export KUBECONFIG="$HOME/.kube/config:$(printf "%s:" $HOME/.kube/configs/*.yaml 2>/dev/null | sed 's/:$//')"

# ----- asdf (optional)
if [ -d "$HOME/.asdf" ]; then
  . "$HOME/.asdf/asdf.sh"
  . "$HOME/.asdf/completions/asdf.bash"
fi
