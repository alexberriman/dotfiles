#!/usr/bin/env bash
# dx - Developer Experience Helper
# Quick reference for dotfiles tools and commands

set -euo pipefail

# Colors
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'

# Helper functions
header() {
  echo -e "\n${BOLD}${BLUE}$1${RESET}"
}

section() {
  echo -e "\n${BOLD}${YELLOW}$1${RESET}"
}

item() {
  printf "${GREEN}  %-32s${RESET}${DIM}%s${RESET}\n" "$1" "$2"
}

show_default() {
  clear
  header "Developer Experience Cheatsheet"

  section "Navigation & Files"
  item "z <dir>" "Jump to directory (learns your paths)"
  item "z -" "Jump to previous directory"
  item "ll" "Enhanced ls with icons & git status"
  item "lt" "Tree view of current directory"
  item "cat <file>" "Syntax highlighted viewer (bat)"
  item "Ctrl+R" "Fuzzy search command history"
  item "Ctrl+T" "Fuzzy find files"

  section "Git"
  item "lg" "Launch lazygit TUI"
  item "git st" "Short status"
  item "git visual" "Pretty commit graph"
  item "git amend" "Amend without editing message"
  item "gh pr create" "Create pull request"
  item "gh pr list" "List pull requests"

  section "Kubernetes"
  item "k9s" "Kubernetes TUI (press ? for help)"
  item "k get pods" "List pods (k = kubectl)"
  item "kx / kx <ctx>" "Switch context (kubectx)"
  item "kx -" "Switch to previous context"
  item "kn / kn <ns>" "Switch namespace (kubens)"
  item "kn -" "Switch to previous namespace"
  item "logs <pod>" "Tail pod logs (stern, partial names ok)"
  item "stern -n <ns> ." "Tail ALL logs in namespace"
  item "kclean" "Delete failed/evicted pods"

  section "Development"
  item "v <file>" "Neovim with LSP & formatting"
  item "nvm use <version>" "Switch Node version"
  item "echo '18' > .nvmrc" "Pin Node version (auto-switches)"
  item "direnv allow" "Enable .envrc in current dir"
  item "btop" "System monitor"

  section "tmux"
  item "Ctrl+h/j/k/l" "Navigate panes (no prefix)"
  item "Ctrl+a c" "New window"
  item "Ctrl+a n/p" "Next/previous window"
  item "Ctrl+a ," "Rename window"
  item "Ctrl+a d" "Detach session"

  echo -e "\n${CYAN}Tip: ${BOLD}dx <category>${RESET}${CYAN} for detailed commands (git|k8s|shell|nvim|tools)${RESET}\n"
}

show_git() {
  header "Git Workflow"

  section "Git TUI"
  item "lg" "Launch lazygit (stage, commit, push, branch, merge)"

  section "Git Aliases"
  item "git st" "Short status (git status -sb)"
  item "git co <branch>" "Checkout branch"
  item "git unstage <file>" "Unstage files"
  item "git undo" "Undo last commit (keeps changes)"
  item "git amend" "Amend last commit without editing message"
  item "git visual" "Pretty graph of all commits"
  item "git last" "Show last commit"

  section "GitHub CLI"
  item "gh pr create" "Create pull request"
  item "gh pr list" "List pull requests"
  item "gh pr view <number>" "View PR details"
  item "gh pr checkout <number>" "Checkout PR locally"
  item "gh repo view --web" "Open repo in browser"

  section "Diff Viewer"
  item "git diff" "Beautiful side-by-side diff (delta)"
  item "git log -p" "Show commits with diffs"

  echo -e "\n${CYAN}Tip: Global .gitignore at ~/.gitignore_global | Identity auto-switches for banja repos${RESET}\n"
}

show_k8s() {
  header "Kubernetes Tools"

  section "Kubernetes TUI"
  item "k9s" "Interactive cluster management (? for help, 0=pods, 1=deployments)"

  section "kubectl Shortcuts"
  item "k get pods" "List pods (k = kubectl)"
  item "k get svc" "List services"
  item "k get deploy" "List deployments"
  item "k describe pod <name>" "Describe pod"
  item "k delete pod <name>" "Delete pod"
  item "k logs <pod>" "Stream pod logs"
  item "k exec -it <pod> -- sh" "Shell into pod"

  section "Context & Namespace Switching"
  item "kx" "List all contexts (kubectx)"
  item "kx <context>" "Switch to context"
  item "kx -" "Switch to previous context"
  item "kn" "List all namespaces (kubens)"
  item "kn <namespace>" "Switch to namespace"
  item "kn -" "Switch to previous namespace"

  section "Advanced Logging (stern)"
  item "logs <pod>" "Tail logs (partial pod name ok)"
  item "stern -n <ns> ." "Tail ALL logs in namespace"
  item "stern <pod> -A" "Search pod across all namespaces"
  item "logs <pod> --since 1h" "Logs from last hour"
  item "logs <pod> -c <container>" "Logs from specific container"
  item "stern <pod> --tail 50" "Show last 50 lines per container"

  section "Cleanup"
  item "kclean" "Delete Evicted/Completed/Error pods (all namespaces)"

  echo -e "\n${CYAN}Tip: Drop .yaml files in ~/.kube/configs/ for auto-merge | k9s: press ? for help${RESET}\n"
}

show_shell() {
  header "Shell Enhancements"

  section "Smart Navigation"
  item "z <partial-name>" "Jump to frequently used directory (learns over time)"
  item "z -" "Go to previous directory"
  item "zi" "Interactive directory picker (fzf)"

  section "Enhanced Listing"
  item "ls" "List with icons and git status (eza)"
  item "ll" "Long format with all details"
  item "lt" "Tree view (2 levels deep)"
  item "la" "List all including hidden, with git status"

  section "Better Viewing"
  item "cat <file>" "Syntax highlighted file viewer (bat)"
  item "less <file>" "Paginated syntax highlighting"

  section "Search & Find"
  item "Ctrl+R" "Fuzzy search command history (fzf)"
  item "Ctrl+T" "Fuzzy find files in current dir"
  item "Alt+C" "Fuzzy cd into directory"
  item "rg <pattern>" "Fast text search (ripgrep)"
  item "fd <pattern>" "Fast file find"

  section "Environment Management (direnv)"
  item "direnv allow" "Enable .envrc in current directory"
  item "echo 'export FOO=bar' > .envrc" "Create environment file"
  item "(auto)" "Auto-loads/unloads when entering/leaving dirs"

  section "Node Version Management (nvm)"
  item "nvm install 18" "Install Node.js version 18"
  item "nvm use 18" "Switch to Node.js 18"
  item "nvm ls" "List installed Node versions"
  item "echo '18.20.0' > .nvmrc" "Pin version (auto-switches on cd)"

  section "Shell Features"
  item "Type any command..." "Auto-suggestions from history (gray text, â†’ to accept)"
  item "Up arrow + type" "Search history matching prefix"

  echo -e "\n${CYAN}Tip: zoxide learns over time, just use 'z' | direnv auto-loads project .envrc${RESET}\n"
}

show_nvim() {
  header "Neovim IDE Features"

  section "Launch"
  item "v <file>" "Open file in neovim"
  item "nvim" "Open neovim (auto-installs plugins on first run)"

  section "File Navigation"
  item "<leader>ff" "Find files (telescope fuzzy finder)"
  item "<leader>fg" "Live grep (search in files)"
  item "<leader>fb" "Buffer list"
  item "<leader>t" "Toggle file tree"

  section "Code Navigation"
  item "gd" "Go to definition (LSP)"
  item "gr" "Find references (LSP)"
  item "K" "Show hover documentation (LSP)"
  item "Ctrl+]" "Jump to tag"

  section "Completion & Editing"
  item "Ctrl+Space" "Trigger completion menu"
  item "Enter" "Accept completion"
  item ":w" "Save (auto-formats with prettier/stylua)"
  item "<leader>w" "Quick save"

  section "Diagnostics & Errors"
  item "<leader>xx" "Toggle diagnostics list (Trouble)"
  item "<leader>xw" "Buffer diagnostics only"
  item "]d" "Next diagnostic"
  item "[d" "Previous diagnostic"

  section "Git Integration"
  item ":Gitsigns blame_line" "Show git blame for current line"
  item "]c" "Next git hunk"
  item "[c" "Previous git hunk"

  section "LSP Management"
  item ":Mason" "Open LSP server manager"
  item ":LspInfo" "Show LSP server status"

  echo -e "\n${CYAN}Tip: Format-on-save enabled | <leader>=Space | Completion auto-triggers${RESET}\n"
}

show_tools() {
  header "Additional Tools"

  section "HTTP & APIs"
  item "http httpbin.org/get" "Make HTTP GET request (httpie)"
  item "http POST api.com/endpoint key=value" "POST with JSON data"

  section "JSON/YAML Processing"
  item "cat file.json | jq '.key'" "Parse and extract from JSON"
  item "cat file.json | jq -r '.[] | .name'" "Extract array values"
  item "cat file.yaml | yq '.key'" "Parse and extract from YAML"

  section "System Monitoring"
  item "btop" "Beautiful interactive process viewer"
  item "btop --utf-force" "Force UTF-8 (if icons look broken)"

  section "Package Management"
  item "brew bundle --file=~/.local/share/chezmoi/Brewfile" "Install/update all packages"
  item "brew bundle cleanup --force" "Remove packages not in Brewfile"
  item "brew update && brew upgrade" "Update Homebrew and packages"

  section "Dotfiles Management"
  item "chezmoi apply" "Apply dotfiles to home directory"
  item "chezmoi diff" "Preview changes before applying"
  item "chezmoi edit ~/.zshrc" "Edit dotfile in source directory"
  item "chezmoi add ~/.config/newfile" "Add new file to dotfiles"
  item "chezmoi update" "Pull from git and apply changes"

  section "First-Time Setup"
  item "cd /path/to/dotfiles && chezmoi init --apply \"\$(pwd)\"" "Initialize from local directory"
  item "chezmoi init --apply https://github.com/user/dotfiles.git" "Initialize from GitHub"

  section "tmux Session & Window Management"
  item "Ctrl+a c" "Create new window"
  item "Ctrl+a n" "Next window"
  item "Ctrl+a p" "Previous window"
  item "Ctrl+a 0-9" "Jump to window number"
  item "Ctrl+a ," "Rename current window"
  item "Ctrl+a w" "List all windows"
  item "Ctrl+a d" "Detach from session"
  item "tmux attach" "Attach to last session"

  section "tmux Pane Management"
  item "Ctrl+h/j/k/l" "Navigate panes (no prefix needed!)"
  item "Ctrl+a %" "Split pane vertically"
  item "Ctrl+a \"" "Split pane horizontally"
  item "Ctrl+a x" "Close current pane"
  item "Ctrl+a z" "Toggle pane zoom (fullscreen)"
  item "Ctrl+a [" "Enter copy mode (vi keys, q to exit)"
  item "Ctrl+a :" "Enter command mode"

  echo -e "\n${CYAN}Tip: All configs managed by chezmoi | tmux prefix is Ctrl+a${RESET}\n"
}

show_all() {
  show_default
  echo ""
  show_git
  echo ""
  show_k8s
  echo ""
  show_shell
  echo ""
  show_nvim
  echo ""
  show_tools
}

# Main
case "${1:-}" in
  git)
    show_git
    ;;
  k8s|kubernetes)
    show_k8s
    ;;
  shell|zsh)
    show_shell
    ;;
  nvim|vim|editor)
    show_nvim
    ;;
  tools|misc)
    show_tools
    ;;
  all)
    show_all | less -R
    ;;
  help|--help|-h)
    echo -e "${BOLD}dx - Developer Experience Helper${RESET}"
    echo ""
    echo "Usage: dx [category]"
    echo ""
    echo "Categories:"
    echo "  (none)   Show top commands (default)"
    echo "  git      Git workflow and GitHub CLI"
    echo "  k8s      Kubernetes tools and shortcuts"
    echo "  shell    Shell enhancements and navigation"
    echo "  nvim     Neovim IDE features and keybindings"
    echo "  tools    Additional utilities and dotfiles management"
    echo "  all      Show everything (piped to less)"
    echo ""
    ;;
  *)
    show_default
    ;;
esac
